Oh, god almighty... this code is a frickin' mess! I refactored it a little bit, but it's still a shitstorm to sift through.
Programming gods, I apologize for my horrible sins...